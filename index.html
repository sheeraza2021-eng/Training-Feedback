<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Training Feedback Form</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0f172a; color:#fff; margin:0; padding:0; }
    .container { max-width: 700px; margin: 40px auto; background:#111827; padding: 25px; border-radius: 12px; box-shadow: 0 0 25px rgba(0,0,0,.4); }
    h2 { text-align:center; color:#f97316; }
    label { display:block; margin-top:12px; font-weight:bold; }
    input, select, textarea, button { width:100%; margin:8px 0; padding:10px; border-radius:8px; border:none; font-size:14px; }
    button { background:#f97316; color:#000; font-weight:bold; cursor:pointer; }
    .q { margin-top:15px; }
    p { text-align:center; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Training Feedback Form</h2>

    <input id="name" placeholder="Name">
    <input id="department" placeholder="Department">
    <input id="designation" placeholder="Designation">
    <input id="email" placeholder="Email">

    <select id="training" onchange="loadQuestions()">
      <option value="">Select Training</option>
    </select>

    <div id="questions"></div>

    <button onclick="submitForm()">Submit Feedback</button>
    <p id="msg"></p>
  </div>

  <script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxACo_BtduyP8qhR-Lxw2ChlemIjY2NwDfsUsNc3RY6erjBa9oA7durJ3y-P1JMvlwFOw/exec";
let questionsCache = [];

/* üîπ Load Active Trainings */
window.onload = () => {
  fetch(WEB_APP_URL + "?action=getTrainings")
    .then(res => res.json())
    .then(list => {
      const select = document.getElementById("training");
      list.forEach(t => {
        const option = document.createElement("option");
        option.value = t.Training_Name;
        option.textContent = t.Training_Name;
        select.appendChild(option);
      });
    })
    .catch(err => console.error("Error loading trainings:", err));
};

/* üîπ Load Questions dynamically for selected training */
function loadQuestions() {
  const trainingName = document.getElementById("training").value;
  const container = document.getElementById("questions");
  container.innerHTML = "Loading questions...";
  if(!trainingName) return;

  fetch(`${WEB_APP_URL}?action=getQuestions&training=${encodeURIComponent(trainingName)}`)
    .then(res => res.json())
    .then(qs => {
      questionsCache = qs;
      container.innerHTML = "";
      qs.forEach(q => {
        const input = q.Question_Type.toLowerCase() === "text"
          ? `<textarea data-id="${q.Question_ID}" placeholder="Enter your answer"></textarea>`
          : `<input type="number" min="1" max="5" data-id="${q.Question_ID}">`;

        container.innerHTML += `
          <div class="q">
            <label>${q.Question_Text}</label>
            ${input}
          </div>`;
      });
    })
    .catch(err => console.error("Error loading questions:", err));
}

/* üîπ Submit Form */
function submitForm() {
  const answers = [];
  document.querySelectorAll("[data-id]").forEach(el => {
    answers.push({
      questionId: el.dataset.id,
      answer: el.value
    });
  });

  const payload = {
    name: document.getElementById("name").value,
    department: document.getElementById("department").value,
    designation: document.getElementById("designation").value,
    email: document.getElementById("email").value,
    training: document.getElementById("training").value,
    answers
  };

  fetch(WEB_APP_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    if(data.status === "success") {
      document.getElementById("msg").innerHTML = `‚úÖ Submitted! Response ID: <b>${data.responseId}</b>`;
      // Reset form
      document.getElementById("name").value = "";
      document.getElementById("department").value = "";
      document.getElementById("designation").value = "";
      document.getElementById("email").value = "";
      document.getElementById("training").value = "";
      document.getElementById("questions").innerHTML = "";
    } else {
      document.getElementById("msg").innerText = "‚ùå Submission failed: " + data.message;
    }
  })
  .catch(err => {
    console.error("Submission error:", err);
    document.getElementById("msg").innerText = "‚ùå Submission failed.";
  });
}
  </script>
</body>
</html>
