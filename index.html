<!DOCTYPE html>
<html>
<head>
  <title>Training Registration & Feedback Form</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f7f9fc; }
    h2 { color: #0d47a1; text-align: center; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; }
    .question { margin-top: 10px; }
    .submit-btn { margin-top: 20px; background-color: #0d47a1; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px; }
    .submit-btn:hover { background-color: #1565c0; }
    .message { margin-top: 20px; font-weight: bold; text-align: center; }
  </style>
</head>
<body>
  <h2>Training Registration & Feedback Form</h2>
  <form id="registrationForm">
    <label>Name:</label>
    <input type="text" id="name" required />

    <label>Email:</label>
    <input type="email" id="email" required />
    <small>E-Certificate will be sent to this email</small>

    <label>Department:</label>
    <input type="text" id="department" required />

    <label>Designation:</label>
    <input type="text" id="designation" />

    <label>Training Name:</label>
    <select id="trainingSelect" required>
      <option value="">Loading trainings...</option>
    </select>

    <div id="questionsContainer"></div>

    <button type="submit" class="submit-btn">Submit</button>
    <div class="message" id="formMessage"></div>
  </form>

  <script>
    // Updated Web App URL
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzV6P1qtAbN8PASlvO8GtTXSmEHGEgQ6Nt7XWc3t90zvysyy2WzZIFToanLhQrd5bHgTw/exec";

    // Fetch Active Trainings
    async function fetchTrainings() {
      try {
        const res = await fetch(`${WEB_APP_URL}?action=getTrainings`);
        const data = await res.json();
        const select = document.getElementById('trainingSelect');
        select.innerHTML = '<option value="">-- Select Training --</option>';
        data.forEach(t => {
          const option = document.createElement('option');
          option.value = t.Training_Name;
          option.text = t.Training_Name;
          select.add(option);
        });
      } catch(err) {
        console.error(err);
        document.getElementById('formMessage').innerText = 'Failed to load trainings';
      }
    }

    // Fetch Feedback Questions for Selected Training
    async function fetchFeedbackQuestions(trainingName) {
      try {
        const res = await fetch(`${WEB_APP_URL}?action=getQuestions&training=${encodeURIComponent(trainingName)}`);
        const data = await res.json();
        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';
        data.forEach(q => {
          const div = document.createElement('div');
          div.className = 'question';
          if(q.Question_Type.toLowerCase() === 'rating') {
            div.innerHTML = `<label>${q.Question_Text}</label>
                             <select data-id="${q.Question_ID}" required>
                               <option value="">-- Select Rating --</option>
                               <option value="1">1</option>
                               <option value="2">2</option>
                               <option value="3">3</option>
                               <option value="4">4</option>
                               <option value="5">5</option>
                             </select>`;
          } else {
            div.innerHTML = `<label>${q.Question_Text}</label>
                             <textarea data-id="${q.Question_ID}" required></textarea>`;
          }
          container.appendChild(div);
        });
      } catch(err) {
        console.error(err);
        document.getElementById('formMessage').innerText = 'Failed to load questions';
      }
    }

    // On Training Selection Change
    document.getElementById('trainingSelect').addEventListener('change', function() {
      if(this.value) fetchFeedbackQuestions(this.value);
      else document.getElementById('questionsContainer').innerHTML = '';
    });

    // On Form Submit
    document.getElementById('registrationForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formMessage = document.getElementById('formMessage');
      formMessage.innerText = 'Submitting...';

      const feedback = [];
      document.querySelectorAll('#questionsContainer select, #questionsContainer textarea').forEach(el => {
        feedback.push({id: el.getAttribute('data-id'), answer: el.value});
      });

      const payload = {
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        department: document.getElementById('department').value,
        designation: document.getElementById('designation').value,
        training: document.getElementById('trainingSelect').value,
        feedback: feedback
      };

      try {
        const res = await fetch(`${WEB_APP_URL}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const text = await res.text();
        formMessage.innerText = text;
        if(text.includes('âœ”')) {
          this.reset();
          document.getElementById('questionsContainer').innerHTML = '';
        }
      } catch(err) {
        console.error(err);
        formMessage.innerText = 'Submission failed';
      }
    });

    // Initial Fetch of Trainings
    fetchTrainings();
  </script>
</body>
</html>
