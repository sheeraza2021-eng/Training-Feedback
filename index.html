<script>
const baseURL = "https://script.google.com/macros/s/YOUR_EXEC_ID/exec";

// Load trainings
function loadTrainings() {
  fetch(baseURL+"?action=getTrainings")
    .then(res => res.json())
    .then(data => {
      const ddl = document.getElementById('training');
      ddl.innerHTML = '<option value="">-- Select Training --</option>';
      data.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t; opt.textContent = t;
        ddl.appendChild(opt);
      });
    })
    .catch(err => alert("Failed to load trainings: "+err));
}

// Load feedback questions
document.getElementById('training').addEventListener('change', function(){
  const training = this.value;
  const container = document.getElementById('feedbackQuestions');
  container.innerHTML='';
  if(!training) return;

  fetch(baseURL+"?action=getQuestions&training="+encodeURIComponent(training))
    .then(res => res.json())
    .then(questions => {
      questions.forEach((q,i)=>{
        const div = document.createElement('div');
        if(q.Question_Type=='Rating'){
          div.innerHTML=`<label>${q.Question_Text}</label>
            <select id='fb${i}' required>
              <option value="">-- Select Rating --</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>`;
        } else {
          div.innerHTML=`<label>${q.Question_Text}</label>
            <textarea id='fb${i}' required></textarea>`;
        }
        container.appendChild(div);
      });
      document.getElementById('feedbackSection').style.display='block';
    })
    .catch(err => alert("Failed to load questions: "+err));
});

// Submit
document.getElementById('submitBtn').addEventListener('click', function(){
  const obj = {
    name: document.getElementById('name').value.trim(),
    email: document.getElementById('email').value.trim(),
    department: document.getElementById('department').value.trim(),
    designation: document.getElementById('designation').value.trim(),
    training: document.getElementById('training').value,
    feedback: Array.from(document.querySelectorAll('#feedbackQuestions select,#feedbackQuestions textarea')).map((el,i)=>({id:'Q'+i, answer:el.value}))
  };

  fetch(baseURL, {
    method:'POST',
    body: JSON.stringify(obj),
    headers:{'Content-Type':'application/json'}
  })
  .then(res => res.text())
  .then(msg => alert(msg))
  .catch(err => alert("Submission failed: "+err));
});

// Init
loadTrainings();
</script>
