<!DOCTYPE html>
<html>
<head>
  <title>Training Registration & Feedback</title>
  <style>
    body { font-family: Arial; background:#0b2a4a; padding:30px; }
    .card { max-width:700px; margin:auto; background:#fff; padding:25px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.2); }
    h2 { text-align:center; color:#0b2a4a; }
    label { display:block; margin-top:15px; font-weight:bold; }
    input, select, textarea { width:100%; padding:10px; margin-top:5px; border-radius:6px; border:1px solid #ccc; }
    button { width:100%; padding:12px; margin-top:25px; background:#f57c00; color:#fff; border:none; border-radius:8px; font-size:16px; cursor:pointer; }
    button:hover { background:#e66b00; }
    .msg { margin-top:15px; text-align:center; color:green; }
    .error { color:red; }
  </style>
</head>
<body>
<div class="card">
  <h2>Training Registration & Feedback Form</h2>

  <label>Name</label>
  <input type="text" id="name" required>

  <label>Email</label>
  <input type="email" id="email" required>
  <small style="color:#555; font-size:13px;">E-Certificate will be sent to this email</small>

  <label>Department</label>
  <input type="text" id="department" required>

  <label>Designation</label>
  <input type="text" id="designation">

  <label>Training Name</label>
  <select id="training">
    <option value="">Loading trainings...</option>
  </select>

  <div id="feedbackSection" style="margin-top:20px; display:none;">
    <h3>Feedback Questions</h3>
    <div id="feedbackQuestions"></div>
  </div>

  <button id="submitBtn">Submit</button>
  <div class="msg" id="msg"></div>
</div>

<script>
  const isGAS = typeof google !== 'undefined' && google.script && google.script.run;

  function showError(message){
    const msg=document.getElementById('msg');
    msg.className='msg error';
    msg.innerText=message;
  }

  // Load Active Trainings
  function loadTrainings(){
    const ddl=document.getElementById('training'); ddl.innerHTML='';
    if(!isGAS){
      ['ISO Awareness','OBE Training'].forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; ddl.appendChild(opt); });
      showError('⚠ Running outside GAS. Mock trainings loaded.');
      return;
    }
    google.script.run.withSuccessHandler(data=>{
      if(!data || data.length==0){ showError('No trainings found'); return; }
      data.forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; ddl.appendChild(opt); });
    }).withFailureHandler(err=>showError('Failed to load trainings: '+err.message)).getTrainings();
  }

  // Load Feedback Questions
  function loadFeedbackQuestions(trainingName){
    const section=document.getElementById('feedbackSection');
    const container=document.getElementById('feedbackQuestions');
    container.innerHTML=''; section.style.display='none';
    if(!trainingName) return;

    if(!isGAS){
      ['Sample Question 1','Sample Question 2'].forEach((q,i)=>{
        const div=document.createElement('div');
        div.innerHTML=`<label>${q}</label><select id='fb${i}'><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>`;
        container.appendChild(div);
      });
      section.style.display='block'; return;
    }

    google.script.run.withSuccessHandler(data=>{
      if(!data || data.length==0) return;
      data.forEach((q,i)=>{
        const div=document.createElement('div');
        if(q.Question_Type=='Rating'){
          div.innerHTML=`<label>${q.Question_Text}</label><select id='fb${i}'><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>`;
        } else {
          div.innerHTML=`<label>${q.Question_Text}</label><textarea id='fb${i}'></textarea>`;
        }
        container.appendChild(div);
      });
      section.style.display='block';
    }).withFailureHandler(err=>showError('Failed to load questions: '+err.message)).getFeedbackQuestions(trainingName);
  }

  document.getElementById('training').addEventListener('change', function(){ loadFeedbackQuestions(this.value); });

  function submitForm(){
    const obj={
      name:document.getElementById('name').value.trim(),
      email:document.getElementById('email').value.trim(),
      department:document.getElementById('department').value.trim(),
      designation:document.getElementById('designation').value.trim(),
      training:document.getElementById('training').value,
      feedback:[]
    };
    if(!obj.name||!obj.email||!obj.department||!obj.training){ showError('Please fill all required fields.'); return; }

    const feedbackElems=document.querySelectorAll('#feedbackQuestions select,#feedbackQuestions textarea');
    feedbackElems.forEach((el,i)=>{ obj.feedback.push({id:'Q'+i, answer:el.value, Question_Text:el.previousElementSibling.innerText}); });

    const msg=document.getElementById('msg'); msg.className='msg'; msg.innerText='Submitting...';

    if(!isGAS){ msg.innerText='✔ Form validated (mock mode). Data not saved.'; return; }

    google.script.run.withSuccessHandler(res=>{ msg.innerText=res; }).withFailureHandler(err=>showError('Submission failed: '+err.message)).saveParticipant(obj);
  }

  document.getElementById('submitBtn').addEventListener('click', submitForm);
  loadTrainings();
</script>
</body>
</html>
